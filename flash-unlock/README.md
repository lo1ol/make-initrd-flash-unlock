# Описание
Фича позволяет загружать Alt Linux с закрытых разделов Рутокен Flash 2.0. Разделы временно становятся открытыми для чтения и/или для записи в зависимости от настроек.

# Требования
Для корректой работы убедитесь, что в системе стоят пакеты opensc, libpcsclite1, udev, make-initrd (>2.11)

# Параметры ядра
Фича поддерживает два параметра 
* __flash-pin__ -- соедржит PIN-код смарт-карты. Эту опцию желательно использовать только при отладе
* __flash-unlock__ -- содержит команды открытия разделов токена при загрузке. Команды передаются в формате: _$DEV_ID=$PERM_, где _$DEV_ID_ -- идентификатор разблокируемого устройства в формате аналогичный параметру _root_. _$PERM_ -- новые права доступа для раздела (_hi_, _ro_, _wo_, _rw_, _cd_).

# Пример 
Фича тестировалась на токене с таким разбиение на разделы
1. ESP раздел с первичным efi загрузчиком (ro, принадлежит администратору)
2. Раздел /boot (ro, принадлежит администратору)
3. Раздел / (hi, принадлежит пользовтелю. В процессе загрузки ОС доступ к нему становится ro)
4. Раздел /home (hi, принадлежит пользовтелю. В процессе загрузки ОС доступ к нему становится rw)

Т.к. корень системы был переводится в ro раздел, то над ним нужно построить overlayfs для временных сохранений изменений над корнем в оперативной памяти. Существующая фича pipeline позволяет это сделать, но ее нужно слегка модифицировать. Требуемые изменения описаны [здесь](https://github.com/osboot/make-initrd/issues/2).

После того, как требуемые изменения внесены, можно пересобрать текущую версию initrd с помощью команды *make-initrd*. Аргументы ядра можно выставить такие:
```bash
flash-unlock=SERIAL=RUTOKEN_MassStorage_3_000000003CA76D61-0:2=ro flash-unlock=SERIAL=RUTOKEN_MassStorage_4_000000003CA76D61-0:3=rw root=pipeline pipeline=waitdev,mountfs,overlayfs,rootfs waitdev=PARTUUID=1f1b75c1-a019-514b-8f9a-dd0a14aedd51 mountfs=dev 
```

В этом примере устройство с серийным идентификатом *"RUTOKEN_MassStorage_3_000000003CA76D61-0:2"* переводится в пержим ro, а второе устройство в режим rw. 

После этого появлется раздел с идентификатом _PARTUUID=1f1b75c1-a019-514b-8f9a-dd0a14aedd51_. Pipeline монтирует его и строит над ним overlayfs, который в дальнейшем считается корнем системы.

## Внесение изменений в кореневой раздел
Для внесения изменений в корневой раздел можно передавать такие аргументы ядру:
```bash
flash-unlock=SERIAL=RUTOKEN_MassStorage_3_000000003CA76D61-0:2=rw flash-unlock=SERIAL=RUTOKEN_MassStorage_4_000000003CA76D61-0:3=rw
```

## Возможные проблемы:
1. Если раздел /boot доступен только для чтения, то grub иногда может выдавать ошибку, что не может туда писать. Чтобы это исправить убедитесь, что опция _GRUB_DEFAULT_ установлена не в режим _'saved'_, а опция _GRUB_SAVEDEFAULT_ уставновлена в _false_
2. Если разделы /boot и /boot/efi (ESP) доступны только для чтения, то это можетпривести к проблемам при загрузки ОС т.к. система будет пытаться смонтировать их для чтения и записи. Чтобы это избежать, укажите в файле /etc/fstab, что эти разделы нужно монтировать как ro.
